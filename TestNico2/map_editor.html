<html>
	<head>
		<link rel="stylesheet" type="text/css" href="./tile.css" />
		<style>
			@font-face{font-family: Emporium;src: url('EMPORIUM.ttf');}
			
			@-webkit-keyframes LOADING {0%{opacity:0.9;}100%{ opacity:0.5;text-shadow:0 0 5px #00f;}}
			@-webkit-keyframes LOADING_1 {0%{opacity:0;width:0;}45%{width:10px;left:250px;opacity:0.2;}50%{opacity:1;box-shadow: 0px 0px 20px 5px rgba(255,183,0,1);width:200px;left:200px;}55%{width:10px;left:300px;opacity:0.2;}100%{opacity:0;width:0;}}
		
			#tileset{float:left;display:block;width:30%;height:100%;border-right:1px solid #DDD;padding:2px;background:#EEE;margin:0;overflow:auto;}
			#mapContainer{float:left;margin:20px;display:block;width:600px;height:600px;margin-left:100px;padding:10px;background:#000;position:relative;overflow:hidden;}
				#mapContainer .message{position:absolute;display:block;top:280px;width:100%;text-align:center;color:#FFF;font-family:Emporium;font-size:40px;opacity:0.9;background: #ffb76b;background: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pgo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDEgMSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSI+CiAgPGxpbmVhckdyYWRpZW50IGlkPSJncmFkLXVjZ2ctZ2VuZXJhdGVkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIwJSIgeTI9IjEwMCUiPgogICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmYjc2YiIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjUwJSIgc3RvcC1jb2xvcj0iI2ZmYTczZCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjUxJSIgc3RvcC1jb2xvcj0iI2ZmN2MwMCIgc3RvcC1vcGFjaXR5PSIxIi8+CiAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNmZjdmMDQiIHN0b3Atb3BhY2l0eT0iMSIvPgogIDwvbGluZWFyR3JhZGllbnQ+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgZmlsbD0idXJsKCNncmFkLXVjZ2ctZ2VuZXJhdGVkKSIgLz4KPC9zdmc+);background: -moz-linear-gradient(top,  #ffb76b 0%, #ffa73d 50%, #ff7c00 51%, #ff7f04 100%);background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffb76b), color-stop(50%,#ffa73d), color-stop(51%,#ff7c00), color-stop(100%,#ff7f04));background: -webkit-linear-gradient(top,  #ffb76b 0%,#ffa73d 50%,#ff7c00 51%,#ff7f04 100%);background: -o-linear-gradient(top,  #ffb76b 0%,#ffa73d 50%,#ff7c00 51%,#ff7f04 100%);background: -ms-linear-gradient(top,  #ffb76b 0%,#ffa73d 50%,#ff7c00 51%,#ff7f04 100%);background: linear-gradient(to bottom,  #ffb76b 0%,#ffa73d 50%,#ff7c00 51%,#ff7f04 100%);filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffb76b', endColorstr='#ff7f04',GradientType=0 );-webkit-background-clip: text;-webkit-text-fill-color: transparent;-webkit-animation:  LOADING 5s infinite;-webkit-animation-direction:alternate;}
				#mapContainer .message:before{content:"";display:block;background:#fff;width:0px;height:1px;border-radius:100%;left:200px;position:absolute;top:25px;-webkit-animation:  LOADING_1 10s infinite;-webkit-animation-delay:5s;}
			#scriptMap{display:inline-block;width:65%;height:10%;padding:10px;}
			
			.editableMap{cursor:pointer;}
			.map{background:#999;display:block;position:absolute;}
			.notEditable{opacity:0.5;}
			.tile{opacity:0.8;}
			#mapContainer .tile{position:absolute;}
			.tile:hover{opacity:1;}
			.tile div{display:block;width:100%;height:100%;}
			
			#tileset .tile{margin:0px !important;cursor:pointer;padding:0px;opacity:0.8;}
			#tileset .tile.selected{margin:0px;border:1px solid #F00;opacity:1;}
			
			.mapPosition{margin:0 auto;}
			
			#mapContainer .goDown,#mapContainer .goUp,#mapContainer .goLeft,#mapContainer .goRight{display:block;position:absolute;background:rgba(0,0,0,0.5);cursor:pointer;z-index:100;}
			#mapContainer .goDown:hover,#mapContainer .goUp:hover,#mapContainer .goLeft:hover,#mapContainer .goRight:hover{background:#005;}
			#mapContainer .goDown,#mapContainer .goUp{width:100%;height:20px;}
			#mapContainer .goRight,#mapContainer .goLeft{width:20px;height:100%;}
			#mapContainer .goRight{right:0px;top:0;}
			#mapContainer .goRight:after{content:"";display:block;top:43%;right:0;position:absolute;width: 0px;height: 0px;border-style: solid;border-width: 25px 0 25px 15px;border-color: transparent transparent transparent #a3a3a3;}
			#mapContainer .goLeft{left:0px;top:0;}
			#mapContainer .goLeft:after{content:"";display:block;top:43%;left:0;position:absolute;width: 0px;height: 0px;border-style: solid;border-width: 25px 15px 25px 0;border-color: transparent #a3a3a3 transparent transparent;}
			#mapContainer .goUp{top:0px;left:0;}
			#mapContainer .goUp:after{content:"";display:block;left:43%;top:0;position:absolute;width: 0px;height: 0px;border-style: solid;border-width: 0 25px 15px 25px;border-color: transparent transparent #a3a3a3 transparent;}
			#mapContainer .goDown{bottom:0px;left:0;}
			#mapContainer .goDown:after{content:"";display:block;left:43%;bottom:0;position:absolute;width: 0px;height: 0px;border-style: solid;border-width: 15px 25px 0 25px;border-color: #a3a3a3 transparent transparent transparent;}
		</style>
	</head>
	<body>
		<div id="tileset">
			<div class="tile grass_water_1_1 selected"></div>
			<div class="tile grass_water_2_1"></div>
			<div class="tile grass_water_3_1"></div>
			<div class="tile grass_water_4_1"></div>
			<div class="tile grass_water_5_1 grass"></div>
			<div class="tile grass_water_6_1"></div>
			<div class="tile grass_water_7_1"></div>
			<div class="tile grass_water_8_1"></div>
			<div class="tile grass_water_9_1"></div>
			<div class="tile grass_water_10_1"></div>
			<div class="tile grass_water_11_1"></div>
			<div class="tile grass_water_12_1"></div>
			<div class="tile grass_water_13_1"></div>
			<div class="tile grass_water_14_1"></div>
			<div class="tile grass_water_15_1"></div>
			<div class="tile grass_water_16_1"></div>
			<div class="tile grass_water_17_1"></div><br/>			
			<div class="tile grass_water_1_2"></div>
			<div class="tile grass_water_2_2"></div>
			<div class="tile grass_water_3_2"></div>
			<div class="tile grass_water_4_2"></div>
			<div class="tile grass_water_5_2"></div>
			<div class="tile grass_water_6_2"></div>
			<div class="tile grass_water_7_2"></div>
			<div class="tile grass_water_8_2"></div>
			<div class="tile grass_water_9_2"></div>
			<div class="tile grass_water_10_2"></div>
			<div class="tile grass_water_11_2"></div>
			<div class="tile grass_water_12_2"></div>
			<div class="tile grass_water_13_2"></div>
			<div class="tile grass_water_14_2"></div>
			<div class="tile grass_water_15_2"></div>
			<div class="tile grass_water_16_2"></div>
			<div class="tile grass_water_17_2"></div><br/>		
			<div class="tile grass_water_1_3"></div>
			<div class="tile grass_water_2_3"></div>
			<div class="tile grass_water_3_3"></div>
			<div class="tile grass_water_4_3"></div>
			<div class="tile grass_water_5_3"></div>
			<div class="tile grass_water_6_3"></div>
			<div class="tile grass_water_7_3"></div>
			<div class="tile grass_water_8_3"></div>
			<div class="tile grass_water_9_3"></div>
			<div class="tile grass_water_10_3"></div>
			<div class="tile grass_water_11_3"></div>
			<div class="tile grass_water_12_3"></div>
			<div class="tile grass_water_13_3"></div>
			<div class="tile grass_water_14_3"></div>
			<div class="tile grass_water_15_3"></div>
			<div class="tile grass_water_16_3"></div>
			<div class="tile grass_water_17_3"></div><br/>	
			<div class="tile grass_water_1_4"></div>
			<div class="tile grass_water_2_4"></div>
			<div class="tile grass_water_3_4"></div>
			<div class="tile grass_water_4_4"></div>
			<div class="tile grass_water_5_4"></div>
			<div class="tile grass_water_6_4"></div>
			<div class="tile grass_water_7_4"></div>
			<div class="tile grass_water_8_4"></div>
			<div class="tile grass_water_9_4"></div>
			<div class="tile grass_water_10_4"></div>
			<div class="tile grass_water_11_4"></div>
			<div class="tile grass_water_12_4"></div>
			<div class="tile grass_water_13_4"></div>
			<div class="tile grass_water_14_4"></div>
			<div class="tile grass_water_15_4"></div>
			<div class="tile grass_water_16_4"></div>
			<div class="tile grass_water_17_4"></div><br/>
		</div>
		<div class="mapPosition">
			<label>X</label><input type="text" name="X"/>
			<label>Y</label><input type="text" name="Y"/>
			<label>Z</label><input type="text" name="Z"/>
			<button id="positionButton">Set position and reload</button>
		</div>
		<div id="mapContainer"><span class="message">Waiting for position...</span></div>
		<textarea id="scriptMap"></textarea>
		<script src="jquery-1.9.1.min.js"   type="text/javascript"></script>
		<script src="maps.js"   type="text/javascript"></script>
		<script>
		var mapConfiguration={width:20,height:20,unit:20};
		var position;
		
		var previousJson="";
		/*
		* tiles types which are obstructive
		*/
		var obstructiveTiles=new Array(
			"grass_water_8_1","grass_water_11_1","grass_water_12_1","grass_water_13_1","grass_water_14_1","grass_water_15_1",
			"grass_water_8_2","grass_water_11_2","grass_water_12_2","grass_water_13_2","grass_water_14_2","grass_water_15_2",
			"grass_water_8_3","grass_water_11_3","grass_water_12_3","grass_water_13_3","grass_water_14_3","grass_water_15_3",
			"grass_water_8_4","grass_water_11_4","grass_water_12_4","grass_water_13_4","grass_water_14_4","grass_water_15_4"
		);
		var selectedClass;
		var mouseDown=false;
		
		$("document").ready(function(){
			$("#positionButton").click(function(){
				init();
			});
		});
		
		function init(){
			if($("#scriptMap").val()!=""){
				previousJson+=$("#scriptMap").val()+"\n";
				console.log(previousJson);
			}
			position={x:$("input[name='X']").val(),y:$("input[name='Y']").val(),z:$("input[name='Z']").val()};
			$("#mapContainer").html('');
			$("#mapContainer").append("<div class='goDown'></div>").append("<div class='goUp'></div>").append("<div class='goLeft'></div>").append("<div class='goRight'></div>");
			
			mapID='map_'+position.z+'_'+position.x+'_'+position.y;

			map=mapContent[mapID];
			//INITIALISATION
	
			var offsetY=100;
			var offsetX=100;
			for(var j=-1;j<=1;j++){
				for(var i=-1;i<=1;i++){
					var id="map_"+position.z+"_"+(position.x*1+i)+"_"+(position.y*1+j);
					if(mapContent[id]!=undefined || id==mapID){
						drawMap(id,offsetY+((mapConfiguration.height)*i*mapConfiguration.unit),offsetX+((mapConfiguration.width)*j*mapConfiguration.unit));
					}
					if(id==mapID){
						$("#"+id).removeClass("notEditable").addClass("editableMap");
					}
				}
			}
			
			//LISTENERS
			$(".goLeft").click(function(){$("input[name='X']").val(position.x*1-1);init();});
			$(".goRight").click(function(){$("input[name='X']").val(position.x*1+1);init();});
			$(".goUp").click(function(){$("input[name='Y']").val(position.y*1-1);init();});
			$(".goDown").click(function(){$("input[name='Y']").val(position.y*1+1);init();});
			
			$("#tileset .tile").click(function(){
				$(".selected").removeClass("selected");
				selectedClass=$(this).attr("class");
				$(this).addClass("selected");
			});
			$("#mapContainer").mousedown(function(){
				mouseDown=true;
			});
			$("#mapContainer").mouseup(function(){
				mouseDown=false;
			});
			$(".editableMap .tile").click(function(){
				if(selectedClass!=undefined && selectedClass!=null){
					changeTile(this);
				}
			});
			$(".editableMap .tile").hover(function(){
				if(selectedClass!=undefined && selectedClass!=null && mouseDown){
					changeTile(this);
				}
			});
		}
		
		function drawMap(mapID,top,left){
			var unit = mapConfiguration.unit;
			$("#mapContainer").append('<div id="'+mapID+'" class="map notEditable" style="left:'+left+'px;top:'+top+'px;"></div');
			$("#"+mapID).css("width",(mapConfiguration.width*mapConfiguration.unit)+"px");
			$("#"+mapID).css("height",(mapConfiguration.height*mapConfiguration.unit)+"px");
			for(var x=0;x<mapConfiguration.width;x++){
				for(var y=0;y<mapConfiguration.height;y++){
					var type="grass";
					if(mapContent[mapID]!=undefined && mapContent[mapID].tile[x+"_"+y]!=undefined){
						type=mapContent[mapID].tile[x+"_"+y];
						if(mapContent[mapID].occupation[x+"_"+y]!=undefined){
							type+=" noPass";
						}
					}
					$("#"+mapID).prepend("<div class='tile "+type+"' id='tile_"+x+"_"+y+"' style='left:"+x*unit+"px;top:"+y*unit+"px;"+"'></div>");
				}
			}
		}
		
		function changeTile(element){
			$(element).removeClass().addClass(selectedClass);
			getJson();
		}
		
		function getJson(){
			var mapJsonScript =previousJson;
			var  occupation=new Array();
			
			var name='map_'+position.z+'_'+position.x+'_'+position.y;
			mapContent[name]=new Object();
		

			mapJsonScript+='mapContent["map_'+position.z+'_'+position.x+'_'+position.y+'"]={';
			
			mapContent[name].position={z:position.z,x:position.x,y:position.y};
			mapJsonScript+="position:{z:"+position.z+",x:"+position.x+",y:"+position.y+"},";
			
			mapContent[name].size={width:mapConfiguration.width,height:mapConfiguration.height};
			mapJsonScript+="size:{width:"+mapConfiguration.width+",height:"+mapConfiguration.height+"},";

			var y=mapConfiguration.height-1;
			var x=mapConfiguration.width-1;
			
			mapContent[name].tile=new Object();
			mapJsonScript+="tile:{";
			$(".editableMap .tile").each(function(){
				var tileClass = $(this).attr("class").replace('tile','').replace(' ','');
				if(tileClass!=""){
					mapContent[name].tile[x+"_"+y]=tileClass;
					mapJsonScript+='"'+x+"_"+y+'"'+":"+'"'+tileClass+'"'+",";
				}
				if($.inArray(tileClass, obstructiveTiles)>0){
					occupation.push('"'+x+"_"+y+'"');
				}
				
				x--;
				if(x<0){
					y--;
					x=mapConfiguration.width-1;
				}
			});
			
			mapContent[name].occupation=new Object();
			mapJsonScript +="},occupation:{";
			for(var i=0;i<occupation.length;i++){
				mapContent[name].occupation[occupation[i]]=0;
				mapJsonScript+=occupation[i]+":0";
				if(i<occupation.length-1){
					mapJsonScript+=",";
				}
			}
			mapJsonScript+="}}";
			$("#scriptMap").val(mapJsonScript);
		}
		</script>
	</body>
</html>